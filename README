luafcgid - a statefull FastCGI daemon for Lua

---
SUMMARY
---

luafcgid is a multithreaded FastCGI server that runs under BSD/Linux.
It manages a number of independent, persistent Lua states, that are then loaded
with Lua scripts from the file system. These scripts are loaded/initialized
on demand, and held in memory for as long as possible. The Lua scripts are also
allowed to interface with the FastCGI libraries: thus providing an extremely
fast, streamlined and lightweight platform from which to develop web-centric
apps in Lua.

---
LICENSE
---

LuaFCGId is provided under the simplified BSD license:

Copyright 2011 Stefan Peters, all rights reserved.

Redistribution and use in source and binary forms, with or without modification, 
are permitted provided that the following conditions are met:

    Redistributions of source code must retain the above copyright notice, this
    list of conditions and the following disclaimer.

    Redistributions in binary form must reproduce the above copyright notice, 
    this list of conditions and the following disclaimer in the documentation 
    and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE ORIGINAL AUTHOR ``AS IS'' AND ANY EXPRESS OR 
IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT 
SHALL THE ORIGINAL AUTHOR OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, 
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT 
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR 
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, 
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
POSSIBILITY OF SUCH DAMAGE.

---

All development testing is done with the following server platform:

-= luafcgid reference platform =-

Hardware:

Pentium 4 3.2 Ghz
Intel MB chipset
Intel Pro+ 1GB ethernet
256MB RAM

Software:

FreeBSD - last stable release
nginx web server - last stable release
Lua - last stable release
libthr - drop-in replacement for libpthread

** NOTE: Further testing may be done on other platforms when available. 
** Volunteers welcome. 

---
PREREQUISITES
---

Lua 5.1
libfcgi 2.4
libpthread/libthr/pthreadw32

---
INSTALLATION
---

See the INSTALL file for your platform. If you do not see a INSTALL file for
your platform, then you can try to use the generic build by running:

# sh configure
# make

You may have to modify the Makefile created by the configure script, and will
have to install manually. Any platform or distribution-specific Makefiles and
initd/rc.d scripts are always welcome and can be submitted by github pull
request, or directly to me:

stefan (at) chehalispost.com


Webserver (nginx):

add the following lines to your server{} section:
   
   location ~ \.lua$ {
	  
	  # for BSD/Linux
      fastcgi_pass   unix:/var/tmp/luafcgid.sock;
      
	  fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
      include        fastcgi_params;
   }

(make sure your root directive is set correctly)
   
---
DESIGN
---

luafcgid spawns and manages a number of worker threads that each contain an 
isolated blocking accept loop. The FastCGI libraries provide a connect queue 
for each worker thread so that transient load spikes can be handled with a 
minimum of fuss.

                           +---------------+                                
                       +-->| worker thread |--+              +-------------+
 +------------------+  |   +---------------+  |              |   scripts   |
 | luafcgid process |--+                      +---- mutex -->| loaded into |
 +------------------+  |   +---------------+  |       |      |  Lua states |
            |          +-->| worker thread |--+       |      +-------------+
            |              +---------------+          |                
            |                                         |             
            +--------------- housekeeping ------------+             
			
Lua is then introduced into the picture by created a shared Lua state for each 
Lua script that is requested. A script can also be loaded into more then one 
state if heavily requested. All scripts - including duplicates (clones) - are
completely isolated from each other. After a state is initialized and loaded 
with a script, it is kept in memory for as long as possible. This allows for 
persistence across HTTP requests. Each Lua VM is run within a worker thread 
as needed. The use of on-demand clones allows for multiple workers to run the 
same popular script. There is a configurable limit to the total number of Lua 
states that luafcgid will maintain. When this limit is reached, popularity and 
aging are used to decide which states to flush and reload with a new script.

Global housekeeping is run on a regular cycle (heartbeat) independent of 
requests. Current tasks include flushing any loaded scripts that have been 
modified. More tasks may be added in the future.
